# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Test and release

on:
  push:
    branches: [ main ]
    tags:
    - '[0-9]'
  pull_request:
    branches: [ main ]

jobs:
  test:

    strategy:
      fail-fast: false
      matrix:
        os:
            - image: "ubuntu-latest"
              short: "linux"
    runs-on: "${{matrix.os.image}}"

    steps:
    - uses: actions/checkout@v3
    - name: Check files
      shell: bash -l {0}
      run: for x in recipes/*/manifests/*.tsv; do grep -e "genus\sspecies" $x; done

  release:
    needs: test
    if: startsWith(github.ref, 'refs/tags')
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - uses: actions/upload-artifact@v3
      with:
        name: manifests
        path: recipes/*/manifests/*.tsv
    - name: Get release notes
      outputs:
        release_notes: ${{ steps.cat.outputs.notes }}
      steps:
        - id: cat
        - run: echo "notes=$(cat ${{ steps.tag.outputs.version }}.txt)" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        name: "version {{ steps.tag.outputs.version }}"
        artifacts: recipes/*/manifests/*.tsv,release_notes/${{ steps.tag.outputs.version }}.json
        bodyFile: "release_notes/${{ steps.tag.outputs.version }}.txt"
        draft: false
        prerelease: false
